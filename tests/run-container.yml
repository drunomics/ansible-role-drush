# Runs tests in a single container.
#
# To run tests with all environment variables set via the environment (e.g.
# when run via travis), run it via
#   ansible-playbook run-container.yml
#
# To run a certain number of tests via ansible, respective hosts can be
# registered in a group, whiches name must be set to the variable
# "limit_groups". See run.yml for an example.
---
- hosts: all:&{{ limit_groups|default('all') }}
  serial: 1
  vars:
    # Define a variable for reading test "env" variables either from a
    # pre-defined "travis_env" variable or ansible's environment.
    env: "{{ travis_env|default(ansible_env) }}"
    docker_image: drunomics/ubuntu-ansible
  tasks:
  - block:
    - name: Start container.
      docker:
        name: "ansible-run-test-{{ env.playbook }}"
        image: "{{ docker_image }}"
        state: reloaded
        volumes:
          - "{{ ansible_env.PWD }}/..:/root/role"

    - name: Check the role/playbook's syntax
      shell: >
        docker exec ansible-run-test-{{ env.playbook }}
        ansible-playbook /root/role/tests/{{ env.playbook }} --syntax-check
      register: result

    - name: Run the role/playbook with ansible-playbook
      shell: >
        docker exec ansible-run-test-{{ env.playbook }}
        ansible-playbook /root/role/tests/{{ env.playbook }}
      register: result

    - name: Run the role/playbook again, checking to make sure it's idempotent.
      shell: >
        docker exec ansible-run-test-{{ env.playbook }}
        ansible-playbook /root/role/tests/{{ env.playbook }} --skip-tags dependency,assert | grep -q 'changed=0.*failed=0' \
          && (echo 'Idempotence test: pass' && exit 0) \
          || (echo 'Idempotence test: fail' && exit 1)
      register: result

    rescue:
      - name: Pretty-print stdout
        debug: var=result.stdout_lines
      - name: Pretty-print errors
        debug: var=result.stderr
        failed_when: true

    always:
      - name: (Quickly) stop testing container
        docker:
          name: "ansible-run-test-{{ env.playbook }}"
          image: "{{ docker_image }}"
          state: killed
        tags: clean-up
      - name: Remove testing container
        docker:
          name: "ansible-run-test-{{ env.playbook }}"
          image: "{{ docker_image }}"
          state: absent
        tags: clean-up
